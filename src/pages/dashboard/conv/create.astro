---
import Layout from '../../../layouts/Layout.astro';

import { AuthService, requireRole } from '../../../utils/auth';
import { getUserFromRequest } from '../../../utils/session';

const user = getUserFromRequest(Astro.request);

// Permitir tanto usuarios como admins
if (!user || !requireRole(user, ['user', 'admin'])) {
  return Astro.redirect('/login');
}

const urlParams = new URLSearchParams(new URL(Astro.request.url).search);
const error = urlParams.get('error');
const today = new Date().toISOString().split('T')[0];

// Debug adicional
console.log('=== FORMULARIO DEBUG ===');
console.log('Usuario en formulario:', user ? { id: user.id, socesId: user.socesId, role: user.role } : 'null');
console.log('Fecha hoy:', today);
---

<Layout title="Crear Convocatoria - User">
  <div class="min-h-screen bg-gray-50">
    <div class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-6">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Crear Nueva Convocatoria</h1>
            <p class="mt-2 text-sm text-gray-600">Completa los datos de la nueva convocatoria</p>
          </div>
          <a href="/dashboard/conv" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
            ← Volver a Convocatorias
          </a>
        </div>
      </div>
    </div>

    <main class="max-w-3xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-6 sm:px-0">
        
        {error && (
          <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
            <div class="text-red-800">
              {error === 'validation' && 'Todos los campos obligatorios deben ser completados correctamente'}
              {error === 'server' && 'Error del servidor. Intenta nuevamente. Revisa la consola para más detalles.'}
            </div>
          </div>
        )}



        <div class="bg-white shadow rounded-lg">
          <div class="px-6 py-6">
            <form action="/dashboard/api/conv/create" method="POST">
              <div class="space-y-6">
                
                <div>
                  <label for="titulo" class="block text-sm font-medium text-gray-700 mb-1">
                    Título <span class="text-red-500">*</span>
                  </label>
                  <input
                    id="titulo"
                    name="titulo"
                    type="text"
                    required
                    minlength="1"
                    maxlength="255"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Título de la convocatoria"
                  />
                </div>

                <div>
                  <label for="contenido" class="block text-sm font-medium text-gray-700 mb-1">
                    Contenido <span class="text-red-500">*</span>
                  </label>
                  <textarea
                    id="contenido"
                    name="contenido"
                    required
                    minlength="1"
                    rows="6"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Contenido de la convocatoria"
                  ></textarea>
                </div>

                <div>
                  <label for="link" class="block text-sm font-medium text-gray-700 mb-1">
                    Enlace de imagen (opcional)
                  </label>
                  <input
                    id="link"
                    name="link"
                    type="url"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="https://ejemplo.com/imagen.jpg"
                  />
                </div>

                <div>
                  <label for="link2" class="block text-sm font-medium text-gray-700 mb-1">
                    Enlace relacionado (opcional)
                  </label>
                  <input
                    id="link2"
                    name="link2"
                    type="url"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="https://ejemplo.com"
                  />
                </div>

                <div>
                  <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">
                    Fecha de publicación <span class="text-red-500">*</span>
                  </label>
                  <input
                    id="fecha"
                    type="date"
                    name="fecha"
                    required
                    value={today}
                    min="2020-01-01"
                    max="2030-12-31"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>

              <div class="mt-8 flex justify-end space-x-3">
                <a 
                  href="/dashboard/conv"
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
                >
                  Cancelar
                </a>
                <button
                  type="submit"
                  class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                >
                  Crear Convocatoria
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</Layout>
