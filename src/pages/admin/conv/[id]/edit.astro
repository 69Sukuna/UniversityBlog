---
import Layout from '../../../../layouts/Layout.astro';
import Form from '../../../../components/ui/Form.astro';
import Input from '../../../../components/ui/Input.astro';
import Button from '../../../../components/ui/Button.astro';
import Alert from '../../../../components/ui/Alert.astro';
import TextArea from '../../../../components/ui/TextArea.astro';
import { getUserFromRequest } from '../../../../utils/session';
import { requireRole } from '../../../../utils/auth';
import { db, Convocatorias, eq, and } from 'astro:db';

const user = getUserFromRequest(Astro.request);

if (!user || !requireRole(user, ['admin'])) {
  return Astro.redirect('/login');
}

const { id } = Astro.params;
const convocatoriaId = parseInt(id || '0');

if (!convocatoriaId) {
  return Astro.redirect('/admin/conv?error=not_found');
}

// Buscar la convocatoria por ID y asegurar que pertenece al usuario (si es necesario)
const con = await db
  .select()
  .from(Convocatorias)
  .where(and(eq(Convocatorias.id, convocatoriaId))); // Si usas userId, añade eq(Convocatorias.userId, user.id)

if (con.length === 0) {
  return Astro.redirect('/admin/conv?error=not_found');
}

const convocatoriaEdit = con[0];

const urlParams = new URLSearchParams(new URL(Astro.request.url).search);
const error = urlParams.get('error');
---

<Layout title={`Editar Convocatoria: ${convocatoriaEdit.titulo}`}>
  <main class="max-w-4xl mx-auto py-10">
    {
      error && (
        <Alert type="error" class="mb-6">
          {error === 'validation' && 'Todos los campos obligatorios deben completarse'}
          {error === 'server' && 'Error del servidor. Intenta nuevamente'}
        </Alert>
      )
    }

    <div class="bg-white shadow rounded-lg px-6 py-8">
      <h1 class="text-2xl font-bold mb-4">Editar Convocatoria</h1>

      <Form action="/api/conv/update" method="POST">
        <input type="hidden" name="convocatoriaId" value={convocatoriaEdit.id} />

        <Input
          name="titulo"
          type="text"
          label="Título"
          value={convocatoriaEdit.titulo}
          required={true}
        />
        
        <TextArea
          name="contenido"
          label="Contenido"
          value={convocatoriaEdit.contenido}
          required={true}
        />

        <Input
          name="link"
          type="text"
          label="Enlace Relacionado (opcional)"
          value={convocatoriaEdit.link || ''}
          required={false}
        />

        <Input
          name="link2"
          type="text"
          label="Enlace Relacionado (opcional)"
          value={convocatoriaEdit.link2 || ''}
          required={false}
        />

        <div class="mt-6 flex justify-end space-x-3">
          <Button href="/admin/conv" variant="secondary">Cancelar</Button>
          <Button type="submit" variant="primary">Actualizar Convocatoria</Button>
        </div>
      </Form>
    </div>
  </main>
</Layout>
